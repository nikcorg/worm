<!doctype html>
<html>
    <head>
        <title>Worm!</title>
        <script type="text/javascript">
            function isArray(o) {
                return Object.prototype.toString.call(o) === "[object Array]";
            }
            function func(name) {
                var rest = Array.prototype.slice.call(arguments, 1);
                return function (ctx) {
                    return ctx[name].apply(ctx, rest);
                }
            }
            function prop(name) {
                return function (ctx) {
                    return ctx[name];
                }
            }
            function last(arr) {
                if (! isArray(arr)) return null;
                return arr[arr.length - 1];
            }
            function truthy(what) {
                return !!what;
            }
        </script>
        <script type="text/javascript">
            var Emitter = (function (w, d) {
                function Emitter() {
                }
                var p = Emitter.prototype;
                Emitter.mixin = function (dest) {
                    var prop;
                    for (prop in p) {
                        if (p.hasOwnProperty(prop)) {
                            dest[prop] = p[prop];
                        }
                    }
                };
                Emitter.emit = function (recvr, args) {
                    recvr.fn.apply(recvr.who, args);
                };
                p.subs = {};
                p.on = function (what, fn, who) {
                    who = who || null;
                    this.subs[what] = (this.subs[what] || []);
                    this.subs[what].push({ fn: fn, who: who });
                    return this;
                };
                p.off = function (what, fn, who) {
                    var i, l;
                    who = who || null;
                    for (i = 0, l = this.subs[what].length; i < l; i++) {
                        if (fn === this.subs[what][i].fn && who === this.subs[what][i].who) {
                            this.subs[what].splice(i, 1);
                            return true;
                        }
                    }
                    return false;
                };
                p.trigger = function (l, e) {
                    var args = Array.prototype.slice.call(arguments, 1);
                    l.forEach(function (s) { Emitter.emit(s, args); );
                };
                return Emitter;
            }(window, document));
        </script>
        <script type="text/javascript">
            var Canvas = (function (w, d) {
                var requestAnimFrame = (function(){
                        return window.requestAnimationFrame ||
                            window.webkitRequestAnimationFrame ||
                            window.mozRequestAnimationFrame ||
                            window.oRequestAnimationFrame ||
                            window.msRequestAnimationFrame ||
                            function (callback) {
                                window.setTimeout(callback, 1000 / 60);
                            };
                        }());
                var Canvas = function (w, h, fps) {
                    this.dims = { w: w, h: h };
                    this.fps = Math.min(fps, 60);
                    this.cnv = d.createElement("canvas");
                    this.cnv.setAttribute("width", this.dims.w);
                    this.cnv.setAttribute("height", this.dims.h);
                    this.ctx = this.cnv.getContext("2d");
                };
                var p = Canvas.prototype;
                Emitter.mixin(p);
                p.subs = {
                    "tick": []
                };
                p.ticking = false;
                p.cnv = null;
                p.ctx = null;
                p.fps = 0;
                p.dims = { w: 0, h: 0 };
                p.tick = function (fn) {
                    var ticker;
                    if (this.ticking) {
                        ticker = this.tick.bind(this);
                        setTimeout(
                            function () { requestAnimFrame(ticker); },
                            1000 / this.fps
                            );
                    }
                    this.trigger(this.subs.tick, "tick");
                };
                p.startTick = function () {
                    this.ticking = true;
                    this.tick();
                };
                p.stopTick = function () {
                    this.ticking = false;
                };
                p.attach = function (node) {
                    node.appendChild(this.cnv);
                    this.startTick();
                };
                p.detach = function () {
                    if (this.cnv.parentNode) {
                        this.cnv.parentNode.removeChild(this.cnv);
                        this.stopTick();
                    }
                };
                p.clear = function () {
                    this.ctx.clearRect(0, 0, this.dims.w, this.dims.h);
                };
                p.fill = function (c) {
                    var restore = !!c ? this.applyOptions({ fillStyle: c }) : null;
                    this.ctx.fillRect(0, 0, this.dims.w, this.dims.h);
                    this.applyOptions(restore);
                };
                p.applyOptions = function (options) {
                    var restore = {},
                        opt;
                    if (!!options) {
                        for (opt in options) {
                            if (opt in this.ctx) {
                                restore[opt] = this.ctx[opt];
                                this.ctx[opt] = options[opt];
                            }
                        }
                    }
                    return restore;
                };
                p.draw = function (canvas, x, y, options) {
                    var restore = !!options ? this.applyOptions(options) : null;
                    this.ctx.drawImage(canvas.cnv, x, y);
                    this.applyOptions(restore);
                };
                return Canvas;
            }(window, document));
        </script>
        <script type="text/javascript">
            var Point = (function (w, d) {
                function Point(x, y) {
                    this.x = x || this.x;
                    this.y = y || this.y;
                }
                var p = Point.prototype;
                p.x = 0;
                p.y = 0;
                p.clone = function () {
                    return new Point(this.x, this.y);
                };
                p.cloneInto = function (o) {
                    o.x = this.x;
                    o.y = this.y;
                };
                return Point;
            }(window, document));
        </script>
        <script type="text/javascript">
            var Rectangle = (function (w, d) {
                function Rectangle(point, width, height) {
                    this.pos = point;
                    this.width = width;
                    this.height = height;
                }
                var p = Rectangle.prototype;
                p.pos = null;
                p.width = 0;
                p.height = 0;
                p.contains = function (point) {
                    return point.x >= this.pos.x && point.x < this.pos.x + this.width &&
                        point.y >= this.pos.y && point.y < this.pos.y + this.height;
                }
                p.setPos = function (point) {
                    this.pos = point;
                    return this;
                };
                return Rectangle;
            }(window, document));
        </script>
        <script type="text/javascript">
            var Target = (function (w, d) {
                function Target(canvas) {
                    this.canvas = canvas;
                    this.randomize();
                }
                Target.height = 10;
                Target.width = 10;
                Target.cache = new Canvas(Target.width, Target.height);
                Target.cache.fill("#F00");
                var p = Target.prototype;
                p.pos = null;
                p.rect = null;
                p.cache = null;
                p.canvas = null;
                p.value = 0;
                p.randomize = function () {
                    var x = Math.random() * this.canvas.dims.w / Target.width,
                        y = Math.random() * this.canvas.dims.h / Target.height;
                    this.value = Math.ceil(Math.random() * 10);
                    this.pos = new Point(
                        Math.floor(x) * Target.width,
                        Math.floor(y) * Target.height
                        );
                    this.rect = new Rectangle(this.pos, Target.width, Target.height);
                    return this;
                };
                p.draw = function () {
                    this.canvas.draw(
                        Target.cache,
                        this.pos.x,
                        this.pos.y
                        );
                    return this;
                };
                p.hitTest = function (point) {
                    return this.rect.contains(point);
                };
                return Target;
            }(window, document));
        </script>
        <script type="text/javascript">
            var Segment = (function (w, d) {
                function Segment(canvas) {
                    this.canvas = canvas;
                    this.rect = new Rectangle(null, Segment.width, Segment.height);
                    this.setPos(new Point(0, 0));
                }
                Segment.height = 10;
                Segment.width = 10;
                Segment.color = "#0F0";
                Segment.cache = new Canvas(Segment.width, Segment.height);
                Segment.cache.fill(Segment.color);
                var p = Segment.prototype;
                p.canvas = null;
                p.pos = null;
                p.rect = null;
                p.hitTest = function (point) {
                    return this.rect.setPos(this.pos).contains(point);
                }
                p.draw = function () {
                    this.canvas.draw(Segment.cache, this.pos.x, this.pos.y);
                    return this;
                };
                p.setPos = function (point) {
                    this.pos = point;
                    return this;
                }
                return Segment;
            }(window, document));
        </script>
        <script type="text/javascript">
            var Worm = (function (w, d) {
                function Worm(canvas) {
                    this.canvas = canvas;
                    this.init();
                    this.direction = Math.floor(Math.random() * 4) + 1;
                }
                Worm.DIRECTION = {
                    UP: 1,
                    DOWN: 2,
                    LEFT: 3,
                    RIGHT: 4
                };
                var p = Worm.prototype;
                p.canvas = null;
                p.direction = Worm.DIRECTION.LEFT;
                p.speed = 1;
                p.length = 1;
                p.segments = [];
                p.segmentQueue = [];
                p.directionChangeAllowed = true;
                p.init = function () {
                    var firstSegment = new Segment(this.canvas),
                        x = Math.random() * this.canvas.dims.w / Segment.width,
                        y = Math.random() * this.canvas.dims.h / Segment.height;
                    firstSegment.pos = new Point(
                        Math.floor(x) * Segment.width,
                        Math.floor(y) * Segment.height
                        );
                    this.segments.push(firstSegment);
                    this.grow(2);
                };
                p.setDirection = function (d) {
                    // Hack to allow dir change only once per tick,
                    // preventing turning into yourself when doing
                    // a quick 180° turn
                    if (this.directionChangeAllowed) {
                        this.direction = d;
                        this.directionChangeAllowed = false;
                    }
                    return this;
                };
                p.move = function () {
                    var newSegment, lastPos = last(this.segments).pos.clone();
                    if (this.segments.length > 0) {
                        // Replace head-segment with new segment or tail
                        if (this.segmentQueue.length > 0) {
                            this.segments.unshift(
                                this.segmentQueue.pop().setPos(this.head().pos.clone())
                                );
                        } else {
                            this.segments.unshift(
                                this.segments.pop().setPos(this.head().pos.clone())
                                );
                        }
                        // Move head segment
                        switch (this.direction) {
                            case Worm.DIRECTION.UP:
                                this.head().pos.y -= this.speed * Segment.height;
                                break;
                            case Worm.DIRECTION.DOWN:
                                this.head().pos.y += this.speed * Segment.height;
                                break;
                            case Worm.DIRECTION.LEFT:
                                this.head().pos.x -= this.speed * Segment.height;
                                break;
                            case Worm.DIRECTION.RIGHT:
                                this.head().pos.x += this.speed * Segment.height;
                                break;
                        }
                        // Wrap y-axis
                        if (this.head().pos.y < 0) {
                            this.head().pos.y = this.canvas.dims.h - Segment.height;
                        } else if (this.segments[0].pos.y >= this.canvas.dims.h) {
                            this.head().pos.y = 0;
                        }
                        // Wrap x-axis
                        if (this.head().pos.x < 0) {
                            this.head().pos.x = this.canvas.dims.w;
                        } else if (this.segments[0].pos.x >= this.canvas.dims.w) {
                            this.head().pos.x = 0;
                        }
                    }
                    // Reset direction change allowing flag
                    this.directionChangeAllowed = true;
                    return this;
                };
                p.hitTest = function (point) {
                    var hit = this.segments.
                        map(func("hitTest", point)).
                        some(truthy);
                    return hit;
                };
                p.head = function () {
                    return this.segments[0];
                };
                p.tail = function () {
                    return this.segments.slice(1);
                }
                p.grow = function (amount) {
                    while (amount-- > 0) {
                        this.segmentQueue.push(new Segment(this.canvas));
                    }
                    return this;
                };
                p.draw = function () {
                    this.segments.forEach(func("draw"));
                    return this;
                };
                return Worm;
            }(window, document));
        </script>
        <script type="text/javascript">
            var Score = (function (w, d) {
                function Score(canvas) {
                    this.canvas = canvas;
                    this.cache = new Canvas(100, 24);
                    this.cachePrep();
                }
                var p = Score.prototype;
                p.displaytext = 0;
                p.score = 0;
                p.alpha = 1;
                p.cache = null;
                p.cachePrep = function () {
                    this.cache.ctx.fillStyle = "#FFF";
                    this.cache.ctx.font = "24px Courier";
                    this.cache.ctx.textAlign = "left";
                    this.cache.ctx.shadowColor = "#FA6";
                    this.cache.ctx.shadowBlur = 10;
                }
                p.update = function () {
                    if (this.cache.ctx.measureText(this.displaytext).width > this.cache.dims.w) {
                        this.cache = new Canvas(this.cache.dims.w * 2);
                        this.cachePrep();
                    }
                    this.cache.clear();
                    this.cache.ctx.fillText(this.displaytext, 0, this.cache.dims.h);
                };
                p.inc = function (n) {
                    this.score += n;
                    this.alpha = 1;
                    this.canvas.on("tick", this.tick, this);
                    return this;
                }
                p.tick = function () {
                    var diff = this.score - this.displaytext;
                    if (diff > 2) {
                        this.displaytext += Math.ceil(diff / 10);
                    } else if (diff > 0) {
                        this.displaytext = this.score;
                    } else if (diff === 0 && this.alpha > 0.3) {
                        this.alpha -= 0.05;
                    } else {
                        this.canvas.off("tick", this.tick, this);
                    }
                    this.update();
                };
                p.draw = function () {
                    this.canvas.draw(
                        this.cache,
                        10,
                        10,
                        {
                            globalAlpha: this.alpha,
                            shadowColor: "#FFF",
                            shadowBlur: this.alpha * 30
                            }
                        );
                    return this;
                };
                return Score;
            }(window, document));
        </script>
        <script type="text/javascript">
            var Game = (function (w, d) {
                function Game(canvas) {
                    this.canvas = canvas;
                    this.canvas.on("tick", this.tick, this);
                    this.worm = new Worm(this.canvas);
                    this.target = new Target(this.canvas);
                    this.score = new Score(this.canvas);
                    this.started = Date.now();
                    this.elems = [this.score, this.target, this.worm];
                    w.addEventListener("keydown", this.keydown.bind(this), false);
                }
                Game.KEYCODES = {
                    DOWN: 40,
                    LEFT: 37,
                    RIGHT: 39,
                    SPACE: 32,
                    UP: 38
                };
                var p = Game.prototype;
                Emitter.mixin(p);
                p.subs = { "gameover": [] };
                p.canvas = null;
                p.paused = false;
                p.score = null;
                p.elems = null;
                p.ended = false;
                p.started = 0;
                p.duration = 0;
                p.tick = function () {
                    if (this.worm.head().hitTest(this.target.pos)) {
                        this.worm.grow(this.target.value);
                        this.score.inc(this.target.value * 10);
                        do {
                            this.target.randomize();
                        } while (this.worm.hitTest(this.target.pos));
                    }
                    if (this.worm.tail().
                        map(func("hitTest", this.worm.head().pos)).
                        some(truthy);
                    ) {
                        this.gameover();
                        return;
                    }
                    this.worm.move();
                    this.canvas.fill();
                    // Redrawing everything on every tick is terribly wasteful,
                    // but we don't care right now.
                    this.elems.map(func("draw"));
                };
                p.keydown = function (e) {
                    if (! "keyCode" in e || (this.paused && e.keyCode !== Game.KEYCODES.SPACE)) return;
                    switch (e.keyCode) {
                        case Game.KEYCODES.DOWN:
                            e.preventDefault();
                            if (this.worm.direction !== Worm.DIRECTION.UP) {
                                this.worm.setDirection(Worm.DIRECTION.DOWN);
                            }
                            break;
                        case Game.KEYCODES.UP:
                            e.preventDefault();
                            if (this.worm.direction !== Worm.DIRECTION.DOWN) {
                                this.worm.setDirection(Worm.DIRECTION.UP);
                            }
                            break;
                        case Game.KEYCODES.LEFT:
                            e.preventDefault();
                            if (this.worm.direction !== Worm.DIRECTION.RIGHT) {
                                this.worm.setDirection(Worm.DIRECTION.LEFT);
                            }
                            break;
                        case Game.KEYCODES.RIGHT:
                            e.preventDefault();
                            if (this.worm.direction !== Worm.DIRECTION.LEFT) {
                                this.worm.setDirection(Worm.DIRECTION.RIGHT);
                            }
                            break;
                        case Game.KEYCODES.SPACE:
                            e.preventDefault();
                            this.pause();
                            break;
                    }
                };
                p.gameover = function () {
                    this.ended = true;
                    this.canvas.off("tick", this.tick, this);
                    this.canvas.applyOptions({
                        font: "90px Courier",
                        fillStyle: "#FFF",
                        textAlign: "center",
                        shadowColor: "#FA6",
                        shadowBlur: 10
                        });
                    this.canvas.ctx.fillText(
                        "GAME OVER",
                        Math.round(this.canvas.dims.w / 2),
                        Math.round(this.canvas.dims.h / 2)
                        );
                    this.canvas.ctx.font = "40px Courier";
                    this.canvas.ctx.fillText(
                        "You scored " + this.score.score + " points",
                        Math.round(this.canvas.dims.w / 2),
                        Math.round(this.canvas.dims.h / 2) + 95
                        );
                    this.updateDuration();
                    this.trigger(this.subs.gameover, "gameover", this);
                };
                p.updateDuration = function () {
                    this.duration += Date.now() - this.started;
                };
                p.pause = function () {
                    if (this.paused && ! this.ended) {
                        this.canvas.on("tick", this.tick, this);
                        this.paused = false;
                        this.started = Date.now();
                    } else {
                        this.paused = this.canvas.off("tick", this.tick, this);

                        if (this.paused) {
                            this.updateDuration();
                        }
                    }
                };
                return Game;
            }(window, document));
        </script>
        <script type="text/javascript">
            (function (w, d) {
                function renderToplist(data) {
                    var container = d.querySelector(".toplist ol");
                    while (container.firstChild !== null) {
                        container.removeChild(container.firstChild);
                    }
                    data.forEach(function (score) {
                        var points = parseInt(score[0], 10),
                            duration = parseInt(score[1], 10) / 1000,
                            when = new Date(parseInt(score[2], 10)),
                            li = d.createElement("li"),
                            txt = d.createTextNode(
                                points + " points in " +
                                duration + " seconds on " +
                                when.toLocaleString()
                                ),
                            snap;
                        if (score.length === 4) {
                            snap = document.createElement("a");
                            snap.setAttribute("href", score[3]);
                            snap.setAttribute("title", "Screenshot of Game Over screen for this game");
                            snap.setAttribute("target", "snap");
                            snap.appendChild(txt);
                            li.appendChild(snap);
                        } else {
                            li.appendChild(txt);
                        }
                        container.appendChild(li);
                    });
                    container.parentNode.removeAttribute("hidden");
                }
                function compileQueryString(vars) {
                    var keys = (function (vars, p) {
                            var ret = [];
                            for (p in vars) {
                                ret.push(p);
                            }
                            ret.sort();
                            return ret;
                            }(vars));
                    return keys.map(
                        function (key) {
                            return key + "=" + encodeURIComponent(vars[key]);
                            }).
                            join("&");
                }
                function appendChecksum(qs) {
                    var cs = qs.split("").
                        reduce(
                            function (acc, curr) {
                                return acc + curr.charCodeAt(0);
                                },
                            0
                            );
                    return qs + "&cs=" + String(cs);
                }
                function persistScore(score, duration, snap, nonce) {
                    var xhr = new XMLHttpRequest();
                    if (nonce == null) {
                        xhr.open("GET", "./worm-score.php", true);
                        xhr.onreadystatechange = function (e) {
                            var xhr = e.target,
                                data;
                            if (xhr.readyState === xhr.DONE) {
                                try {
                                    data = JSON.parse(xhr.responseText);
                                    renderToplist(data.scores);
                                    if ("nonce" in data) {
                                        persistScore(score, duration, snap, data.nonce);
                                    }
                                } catch (e) {}
                            }
                        };
                        xhr.send();
                    } else if (!!score && score > 0 && !!duration && !!nonce) {
                        xhr.open("POST", "./worm-score.php", true);
                        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                        xhr.onreadystatechange = function (e) {
                            var xhr = e.target,
                                data;
                            if (xhr.readyState === xhr.DONE) {
                                try {
                                    data = JSON.parse(xhr.responseText);
                                    renderToplist(data.scores);
                                } catch (e) {}
                            }
                        };
                        xhr.send(appendChecksum(compileQueryString({
                            duration: duration,
                            nonce: nonce,
                            score: score,
                            snap: snap || ""
                            })));
                    }
                }
                w.addEventListener(
                    "load",
                    function () {
                            var g = new Game(new Canvas(640, 480, 15));
                            g.canvas.attach(d.querySelector(".canvasContainer"));
                            g.on(
                                "gameover",
                                function (evt, game) {
                                    persistScore(
                                        game.score.score,
                                        game.duration,
                                        game.canvas.cnv.toDataURL("image/png")
                                        );
                                    }
                                );
                            persistScore(-1);
                        },
                    false
                    );
            }(window, document));
        </script>
        <style type="text/css">
            body {
                font-style: sans-serif;
            }
        </style>
    </head>
    <body>
        <h1>Worm!</h1>
        <div class="canvasContainer"></div>
        <p>Use arrow keys to steer, spacebar to (un)pause</p>
        <p>Edges wrap, hitting the body ends the game.</p>
        <p>Reload page to restart game.</p>
        <div class="toplist"><h2>High scores</h2><ol></ol></div>
        <p><i>Disclaimer:</i> Because this is just a PoC, there are no checks for supported tech in your browser and this game is not guaranteed to work anywhere. (But in a recent browser there are no reasons why it wouldn't.)</p>
    </body>
</html>
